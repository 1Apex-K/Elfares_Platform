<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تسجيل حساب جديد - عالم الفرسان</title>
  <link rel="stylesheet" href="auth.css"> </head>
<body>
  <div class="login-container">
    <div class="login-card">
      <img src="reg.jpeg" alt="Logo">
      <h2>عالم الفرسان</h2>

      <p class="intro">اهلا بيك ف عالم الفرسان</p>
      <p class="intro">ابدأ دلوقتي يلا معانا ⬇</p>

      <form action="/register" method="post">
        <div class="flex-inputs">
          <input type="text" name="first_name" placeholder="الاسم الأول" required>
          <input type="text" name="second_name" placeholder="الاسم الثاني" required>
        </div>
        <div class="flex-inputs">
          <input type="text" name="third_name" placeholder="الاسم الثالث" required>
          <input type="text" name="fourth_name" placeholder="الاسم الرابع" required>
        </div>

        <div class="input-group">
          <select name="grade" required>
            <option value="" disabled selected>اختر السنة الدراسية</option>
            <option value="1">أولى ثانوي</option>
            <option value="2">ثانية ثانوي</option>
            <option value="3">ثالثة ثانوي</option>
          </select>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="azhari" name="azhari">
          <label for="azhari">هل أنت طالب أزهري</label>
        </div>
        
        <div class="input-group">
          <input type="tel" name="parent_mobile" placeholder="رقم موبايل ولي الأمر" pattern="[0-9]*" inputmode="numeric" required>
        </div>
        
        <div class="input-group">
          <input type="tel" name="mobile" placeholder="رقم الموبايل" pattern="[0-9]*" inputmode="numeric" required>
        </div>

        <div class="input-group">
          <input type="password" name="password" placeholder="كلمة المرور" id="password" required>
        </div>

        <button type="submit">تسجيل حساب جديد</button>
      </form>

      <p class="register-link">
        لديك حساب؟ <a href="login.html">تسجيل الدخول</a>
      </p>
    </div>
  </div>
<script type="module" src="firebase.js"></script>

<script type="module">
  import { createUserWithEmailAndPassword } 
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { firebaseAuth, firebaseDB } from "./firebase.js";

  import { doc, setDoc } 
  from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const form = document.querySelector("form");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const first = form.first_name.value;
    const second = form.second_name.value;
    const third = form.third_name.value;
    const fourth = form.fourth_name.value;
    const mobile = form.mobile.value;
    const parent = form.parent_mobile.value;
    const grade = form.grade.value;
    const password = form.password.value;

    // التحقق من حقول الاسم الأربعة قبل إنشاء البريد
    if (!first || !second || !third || !fourth) {
      alert("الرجاء إدخال الاسم الرباعي كاملاً.");
      return;
    }
    
    // التحقق من طول كلمة المرور (تحسين)
    if (password.length < 6) {
        alert("كلمة المرور يجب أن تكون 6 أحرف على الأقل.");
        return;
    }


    const email = mobile + "@elfares.com";

    try {
      const userCredential = await createUserWithEmailAndPassword(firebaseAuth, email, password);
      const user = userCredential.user;

      // إضافة الطالب كـ أزهري فقط في حال تم تفعيل الـ checkbox
      const isAzhari = form.azhari?.checked ?? false; 

      await setDoc(doc(firebaseDB, "students", user.uid), {
        first,
        second,
        third,
        fourth,
        mobile,
        parent,
        grade,
        azhari: isAzhari,
        createdAt: new Date()
      });

      alert("تم إنشاء الحساب بنجاح!");
      window.location.href = "login.html";

    } catch (error) {
      // تحسين رسائل الخطأ
      let errorMessage = "حدث خطأ غير متوقع.";
      if (error.code === 'auth/email-already-in-use') {
          errorMessage = "هذا الرقم (البريد الإلكتروني) مستخدم بالفعل.";
      } else if (error.code === 'auth/weak-password') {
          errorMessage = "كلمة المرور ضعيفة جداً، الرجاء اختيار كلمة مرور أقوى (6 أحرف على الأقل).";
      } else {
          errorMessage = "خطأ: " + error.message;
      }
      
      alert(errorMessage);
    }
  });
</script>

</body>
</html>